<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Botànica UAB</title>
    
    <!-- Leaflet CSS per al mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Estils propis -->
    <link rel="stylesheet" href="assets/css/galeria-botanica.css">
    <link rel="stylesheet" href="assets/css/mapa-botanica.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Galeria Botànica UAB</h1>
            <nav class="app-nav">
                <button onclick="mostrarGaleria()" class="nav-btn active" id="btn-galeria">Galeria</button>
                <button onclick="mostrarMapa()" class="nav-btn" id="btn-mapa">Mapa</button>
            </nav>
        </header>

        <main class="app-main">
            <!-- GALERIA -->
            <div id="galeria-section" class="galeria-botanica">
                <!-- Els filtres i la graella es generaran dinàmicament amb JS -->
            </div>

            <!-- MAPA -->
            <div id="mapa-section" class="mapa-botanica-contenidor" style="display: none;">
                <!-- Els filtres del mapa es generaran dinàmicament -->
            </div>
        </main>

        <!-- Modal per detalls -->
        <div class="planta-modal" style="display: none;">
            <div class="planta-modal-contingut">
                <span class="planta-modal-tancar">&times;</span>
                <div class="planta-modal-cos"></div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Carregant galeria botànica...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    
    <!-- Variables globals per compatibilitat amb WordPress -->
    <script>
        // Variables globals necessàries per als scripts originals
        var gb_vars = {
            ajaxurl: 'api/ajax.php' // Simulem l'AJAX de WordPress
        };
        
        var mb_vars = {
            ajaxurl: 'api/ajax.php',
            plugin_url: '.',
            dades_plantes: [] // Es carregarà dinàmicament
        };
        
        // Variable global per a les dades de plantes (per la galeria)
        var gb_plantes_data = [];
    </script>
    
    <!-- Scripts originals de WordPress adaptats -->
    <script src="assets/js/galeria-botanica-original.js"></script>
    <script src="assets/js/mapa-botanica-original.js"></script>
    
    <!-- Script d'inicialització (DESPRÉS de carregar els altres scripts) -->
    <script>
        // Sistema per assignar imatges automàticament
        class SistemaImatges {
            constructor() {
                this.imatgesDisponibles = new Map(); // Mapa de nom_cientific -> llista d'imatges
                this.tipusImatges = {
                    'flor': 'flor',
                    'fulla': 'fulla', 
                    'fruit': 'fruit',
                    'tija': 'tija',
                    'habit': 'habit',
                    'altre': 'altre'
                };
            }

            // Convertir nom científic a format de fitxer
            nomCientificAFitxer(nomCientific) {
                return nomCientific.toLowerCase()
                                  .replace(/\s+/g, '_')
                                  .replace(/[^a-z0-9_]/g, '');
            }

            // Generar llista de possibles noms d'imatges per una planta
            generarPossiblesImatges(nomCientific) {
                const nomFitxer = this.nomCientificAFitxer(nomCientific);
                const possiblesImatges = [];
                
                // Generar possibles noms per números 00-20 i tots els tipus
                for (let num = 0; num <= 20; num++) {
                    const numStr = num.toString().padStart(2, '0');
                    Object.keys(this.tipusImatges).forEach(tipus => {
                        possiblesImatges.push(`${nomFitxer}_${numStr}_${tipus}.jpg`);
                    });
                }
                
                return possiblesImatges;
            }

            // Verificar si una imatge existeix (usant una tècnica que no generi errors 404)
            async verificarImatgeExisteix(rutaImatge) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = rutaImatge;
                });
            }

            // Trobar totes les imatges disponibles per una planta
            async trobarImatgesPlanta(nomCientific) {
                const possiblesImatges = this.generarPossiblesImatges(nomCientific);
                const imatgesTrobades = [];
                
                // Crear promeses per verificar totes les imatges en paral·lel
                const verificacions = possiblesImatges.map(async (nomImatge) => {
                    const rutaCompleta = `assets/imatges/${nomImatge}`;
                    const existeix = await this.verificarImatgeExisteix(rutaCompleta);
                    
                    if (existeix) {
                        // Extreure informació del nom del fitxer
                        const parts = nomImatge.replace('.jpg', '').split('_');
                        const numero = parts[parts.length - 2];
                        const tipus = parts[parts.length - 1];
                        
                        return {
                            nom: nomImatge,
                            ruta: rutaCompleta,
                            numero: parseInt(numero),
                            tipus: tipus
                        };
                    }
                    return null;
                });
                
                // Esperar totes les verificacions
                const resultats = await Promise.all(verificacions);
                
                // Filtrar nulls i ordenar per número
                return resultats.filter(img => img !== null)
                               .sort((a, b) => a.numero - b.numero);
            }

            // Assignar imatges a una planta
            async assignarImatgesPlanta(planta) {
                console.log(`Buscant imatges per: ${planta.nom_cientific}`);
                
                const imatgesTrobades = await this.trobarImatgesPlanta(planta.nom_cientific);
                
                if (imatgesTrobades.length === 0) {
                    console.warn(`No s'han trobat imatges per: ${planta.nom_cientific}`);
                    return {
                        principal: null,
                        principal_tipus: 'general',
                        detalls: [],
                        detalls_tipus: []
                    };
                }
                
                console.log(`Trobades ${imatgesTrobades.length} imatges per: ${planta.nom_cientific}`);
                
                // Assignar la primera imatge com a principal
                const principal = imatgesTrobades[0];
                
                // La resta com a detalls
                const detalls = imatgesTrobades.slice(1);
                
                return {
                    principal: principal.nom,
                    principal_tipus: principal.tipus,
                    detalls: detalls.map(img => img.nom),
                    detalls_tipus: detalls.map(img => img.tipus)
                };
            }

            // Processar totes les plantes del JSON
            async processarTotesLesPlantes(plantes) {
                console.log('Iniciant assignació automàtica d\'imatges...');
                const plantesAmbImatges = [];
                
                for (const planta of plantes) {
                    const imatges = await this.assignarImatgesPlanta(planta);
                    plantesAmbImatges.push({
                        ...planta,
                        imatges: imatges
                    });
                }
                
                console.log('Assignació d\'imatges completada!');
                return plantesAmbImatges;
            }
        }
        
        // Funcions de navegació
        function mostrarGaleria() {
            document.getElementById('galeria-section').style.display = 'block';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-galeria').classList.add('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarMapa() {
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'block';
            
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.add('active');
            
            // Redimensionar el mapa si ja existeix
            if (window.map) {
                setTimeout(() => window.map.invalidateSize(), 100);
            }
        }
        
        // Processar dades per al mapa (format compatible)
        function processarDadesPerMapa(plantes) {
            return plantes.map(planta => ({
                ...planta,
                imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
                habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio_norm: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? 
                        planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                        [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
                usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
                fullatge: planta.caracteristiques?.fullatge || '',
                info_completa: construirInfoCompleta(planta)
            }));
        }
        
        // Construir informació completa per la cerca
        function construirInfoCompleta(planta) {
            let info = [
                planta.nom_comu, 
                planta.nom_cientific, 
                planta.familia, 
                planta.descripcio, 
                planta.tipus
            ];
            
            if (planta.caracteristiques) {
                Object.values(planta.caracteristiques).forEach(valor => {
                    if (Array.isArray(valor)) {
                        info.push(...valor);
                    } else if (valor) {
                        info.push(valor);
                    }
                });
            }
            
            if (planta.usos) {
                const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...usosNetejats);
            }
            
            if (planta.colors) {
                const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...colorsNetejats);
            }
            
            if (planta.habitat) {
                const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...habitatsNetejats);
            }
            
            return info.filter(i => i).join(' ');
        }
        
        // Carregar dades i inicialitzar DESPRÉS que tots els scripts estiguin carregats
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Mostrar loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // Carregar dades de plantes
                const response = await fetch('dades/plantes.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Assignar imatges automàticament
                const sistemaImatges = new SistemaImatges();
                const plantesAmbImatges = await sistemaImatges.processarTotesLesPlantes(data.plantes);
                
                // Assignar a variables globals
                gb_plantes_data = plantesAmbImatges;
                mb_vars.dades_plantes = processarDadesPerMapa(plantesAmbImatges);
                
                console.log('Dades carregades:', plantesAmbImatges.length, 'plantes amb imatges');
                
                // Esperar que les funcions estiguin disponibles
                let intents = 0;
                const esperarFuncions = () => {
                    if (typeof window.generarGaleriaHTML === 'function' && typeof window.generarMapaHTML === 'function') {
                        // Generar contingut de la galeria
                        window.generarGaleriaHTML(plantesAmbImatges).then(() => {
                            // Generar contingut del mapa
                            return window.generarMapaHTML();
                        }).then(() => {
                            // Amagar loading
                            document.getElementById('loading-overlay').classList.add('hidden');
                            console.log('Aplicació inicialitzada correctament');
                        });
                    } else {
                        intents++;
                        if (intents < 50) { // Màxim 5 segons d'espera
                            setTimeout(esperarFuncions, 100);
                        } else {
                            console.error('No s\'han pogut carregar les funcions necessàries');
                            document.getElementById('loading-overlay').innerHTML = 
                                '<div style="color: red; text-align: center;"><h3>Error carregant l\'aplicació</h3><p>Si us plau, recarrega la pàgina.</p></div>';
                        }
                    }
                };
                
                esperarFuncions();
                
            } catch (error) {
                console.error('Error carregant dades:', error);
                document.getElementById('loading-overlay').innerHTML = 
                    `<div style="color: red; text-align: center;">
                        <h3>Error carregant les dades</h3>
                        <p>${error.message}</p>
                        <p>Si us plau, recarrega la pàgina.</p>
                    </div>`;
            }
        });
    </script>
</body>
</html>
