<!DOCTYPE html>
<html lang="ca">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Galeria BotÃ nica UAB</title>
   
   <!-- Leaflet CSS per al mapa -->
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
   <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
   
   <!-- Estils propis -->
   <link rel="stylesheet" href="assets/css/galeria-botanica.css">
   <link rel="stylesheet" href="assets/css/mapa-botanica.css">
   <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
   <div class="app-container">
       <header class="app-header">
           <h1>Galeria BotÃ nica UAB</h1>
           <nav class="app-nav">
               <button onclick="mostrarInici()" class="nav-btn active" id="btn-inici">Inici</button>
               <button onclick="mostrarGaleria()" class="nav-btn" id="btn-galeria">Galeria</button>
               <button onclick="mostrarMapa()" class="nav-btn" id="btn-mapa">Mapa</button>
           </nav>
       </header>

       <main class="app-main">
           <!-- INICI -->
           <div id="inici-section">
               <div class="inici-hero">
                   <h1>ğŸŒ¿ Galeria i Mapa BotÃ nica UAB</h1>
                   <div class="subtitol">Descobreix la biodiversitat del campus de la Universitat AutÃ²noma de Barcelona</div>
                   <div class="descripcio">
                       Benvinguts i benvingudes al portal que converteix els <strong>260 ha</strong> de zones verdes de la UAB 
                       en un herbari digital interactiu.
                   </div>
                   
                   <div class="inici-stats">
                       <div class="stat-item">
                           <span class="stat-number">300+</span>
                           <span class="stat-label">EspÃ¨cies</span>
                       </div>
                       <div class="stat-item">
                           <span class="stat-number">1800+</span>
                           <span class="stat-label">Fotografies</span>
                       </div>
                       <div class="stat-item">
                           <span class="stat-number">260</span>
                           <span class="stat-label">HectÃ rees</span>
                       </div>
                   </div>
               </div>

               <div class="cta-buttons">
                   <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                       ğŸƒ Explora la Galeria
                   </a>
                   <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                       ğŸ—ºï¸ Viatja pel Mapa
                   </a>
               </div>

               <div class="inici-grid">
                   <div class="inici-card">
                       <h3>ğŸ” Galeria BotÃ nica</h3>
                       <p>Un catÃ leg visual filtrable amb fotos detallades (flor, fulla, fruit, hÃ bit) i fitxa completa.</p>
                       <p><strong>Com t'ajuda:</strong> Identifica espÃ¨cies rÃ pidament amb filtres per color, hÃ bitat o Ã¨poca de floraciÃ³.</p>
                   </div>
                   
                   <div class="inici-card">
                       <h3>ğŸ—ºï¸ Mapa BotÃ nic</h3>
                       <p>Un mapa interactiu amb marcadors geolocalitzats i rutes temÃ tiques que situa cada planta <em>in situ</em>.</p>
                       <p><strong>Com t'ajuda:</strong> Organitza sortides, troba exemplars singulars i segueix itineraris auto-guiats.</p>
                   </div>
                   
                   <div class="inici-card">
                       <h3>âš¡ Cercador Instantani</h3>
                       <p>Cerca per nom cientÃ­fic o vulgar en temps real.</p>
                       <p><strong>Com t'ajuda:</strong> Troba la planta que busques en segons.</p>
                   </div>
               </div>

               <div class="inici-card">
                   <h3>ğŸ¯ Per quÃ¨ un catÃ leg botÃ nic del campus?</h3>
                   <p>El campus de Bellaterra Ã©s molt mÃ©s que aules i laboratoris: Ã©s un mosaic de <strong>boscos mediterranis, torrents i camps</strong> que actua de corredor biolÃ²gic entre el MassÃ­s de Sant LlorenÃ§ i Collserola. Documentar-ho tÃ© tres grans avantatges:</p>
                   
                   <table class="inici-table">
                       <thead>
                           <tr>
                               <th>Ã€mbit</th>
                               <th>Com t'ajuda</th>
                           </tr>
                       </thead>
                       <tbody>
                           <tr>
                               <td><strong>ğŸ“š DocÃ¨ncia</strong></td>
                               <td>Facilita la identificaciÃ³ de plantes durant sortides de camp i prÃ ctiques</td>
                           </tr>
                           <tr>
                               <td><strong>ğŸ”¬ CiÃ¨ncia</strong></td>
                               <td>Genera dades fiables per a projectes de recerca i seguiment de biodiversitat</td>
                           </tr>
                           <tr>
                               <td><strong>ğŸŒ± DivulgaciÃ³</strong></td>
                               <td>Apropa la botÃ nica a qualsevol persona que passegi pel campus</td>
                           </tr>
                       </tbody>
                   </table>
               </div>

               <div class="zones-clau">
                   <h3>ğŸ—ºï¸ Zones clau per comenÃ§ar a explorar</h3>
                   
                   <div class="zona-item">
                       <div class="zona-nom">ğŸŒ³ CamÃ­ de Ho Chi Minh</div>
                       <div>Alzinar amb arbusts mediterranis i orquÃ­dies de primavera.</div>
                   </div>
                   
                   <div class="zona-item">
                       <div class="zona-nom">ğŸŒŠ Torrent de Can DomÃ¨nech</div>
                       <div>VegetaciÃ³ de ribera amb salzes, joncs i freixes.</div>
                   </div>
                   
                   <div class="zona-item">
                       <div class="zona-nom">ğŸŒº Eix Central</div>
                       <div>Arborets ornamentals que combinen espÃ¨cies autÃ²ctones i exÃ²tiques.</div>
                   </div>
                   
                   <div class="zona-item">
                       <div class="zona-nom">ğŸŒ¾ Rondes del campus</div>
                       <div>Prats oberts ideals per observar floraciÃ³ estacional d'herbÃ cies.</div>
                   </div>
               </div>

               <div class="caracteristiques-tecniques">
                   <h3>âš™ï¸ Com s'ha construÃ¯t la plataforma?</h3>
                   <ul>
                       <li><strong>Plugin de WordPress</strong> 100% codi obert â€“ dos <em>shortcodes</em> carreguen la galeria i el mapa.</li>
                       <li><strong>Fitxer Ãºnic <code>plantes.json</code></strong> â€“ la "font de la veritat" que evita dades duplicades.</li>
                       <li><strong>Leaflet + Tailwind</strong> â€“ mapa lleuger i disseny adaptat a mÃ²bil i escriptori.</li>
                       <li><strong>Editor offline integrat</strong> â€“ afegeix o edita espÃ¨cies sense tocar codi grÃ cies a la File System Access API (opcional).</li>
                       <li><strong>LlicÃ¨ncia MIT</strong> â€“ pots forquejar, millorar o portar el projecte al teu entorn.</li>
                   </ul>
               </div>

               <div class="inici-card">
                   <h3>ğŸ‘¥ A qui va dirigit?</h3>
                   <ul>
                       <li><strong>Estudiantat de Biologia, CiÃ¨ncies Ambientals i EducaciÃ³</strong> â€“ recurs per a prÃ ctiques i TFG/TFM.</li>
                       <li><strong>Professorat</strong> â€“ material didÃ ctic per a classes i sortides.</li>
                       <li><strong>Investigadors/es</strong> â€“ punt de partida per a estudis de biodiversitat local.</li>
                       <li><strong>PÃºblic general</strong> â€“ eina per gaudir i entendre la natura del campus.</li>
                   </ul>
               </div>

               <div class="inici-card">
                   <h3>ğŸš€ Plans de futur</h3>
                   <ol>
                       <li><strong>Miniatures WebP</strong> per accelerar encara mÃ©s la galeria.</li>
                       <li><strong>API REST</strong> perquÃ¨ aplicacions mÃ²bils (p. ex. Planttes) consumeixin dades en temps real.</li>
                       <li><strong>VersiÃ³ PWA</strong> amb funcionalitat offline completa.</li>
                       <li><strong>TraducciÃ³ multilingÃ¼e</strong> per compartir el recurs amb estudiants internacionals.</li>
                       <li><strong>Nous camps</strong>: polÂ·linitzadors, estatus de protecciÃ³ i fenologia mensual.</li>
                   </ol>
               </div>

               <div class="col-laboracio">
                   <h3>ğŸ¤ Com pots colÂ·laborar?</h3>
                   
                   <div class="col-laboracio-grid">
                       <div class="col-laboracio-item">
                           <strong>ğŸ“¸ Afegir dades o fotos</strong><br>
                           Obre un <em>Pull Request</em> o puja una <em>Issue</em> amb la teva proposta.
                       </div>
                       
                       <div class="col-laboracio-item">
                           <strong>ğŸ› Reportar un error</strong><br>
                           Indica la planta, captura de pantalla i pas a pas per reproduir-lo.
                       </div>
                       
                       <div class="col-laboracio-item">
                           <strong>ğŸŒ Traduir la interfÃ­cie</strong><br>
                           Crea un fitxer a <code>/lang</code> seguint l'estructura JSON existent.
                       </div>
                       
                       <div class="col-laboracio-item">
                           <strong>ğŸš¶ Organitzar una sortida guiada</strong><br>
                           Escriu a <a href="mailto:botanica@uab.cat" style="color: #E8F5E8;">botanica@uab.cat</a>
                       </div>
                   </div>
               </div>

               <div class="credits">
                   <h3>ğŸ‘¨â€ğŸ“ CrÃ¨dits</h3>
                   <p>Projecte desenvolupat com a <strong>Treball de Fi de Grau</strong> a la Facultat de BiociÃ¨ncies de la UAB.</p>
                   <p><strong>Autor:</strong> <em>TomÃ¡s GonzÃ¡lez Bartomeu</em></p>
                   <p><strong>Tutor acadÃ¨mic:</strong> <em>Ramon PÃ©rez Obiol</em></p>
               </div>

               <div class="cta-buttons">
                   <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                       ğŸƒ Explora la Galeria
                   </a>
                   <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                       ğŸ—ºï¸ Viatja pel Mapa
                   </a>
               </div>

               <div style="text-align: center; margin: 2rem 0; color: #4CAF50; font-size: 1.2rem; font-weight: 600;">
                   ğŸŒ± Ajuda'ns a fer crÃ©ixer el coneixement de la flora local!
               </div>
           </div>

           <!-- GALERIA -->
           <div id="galeria-section" class="galeria-botanica" style="display: none;">
               <!-- Els filtres i la graella es generaran dinÃ micament amb JS -->
           </div>

           <!-- MAPA -->
           <div id="mapa-section" class="mapa-botanica-contenidor" style="display: none;">
               <!-- Els filtres del mapa es generaran dinÃ micament -->
           </div>
       </main>

       <!-- Modal per detalls -->
       <div class="planta-modal" style="display: none;">
           <div class="planta-modal-contingut">
               <span class="planta-modal-tancar">&times;</span>
               <div class="planta-modal-cos"></div>
           </div>
       </div>

       <!-- Loading overlay -->
       <div id="loading-overlay" class="loading-overlay">
           <div class="loading-spinner"></div>
           <p>Carregant galeria botÃ nica...</p>
       </div>
   </div>

   <!-- Scripts -->
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
   
   <!-- Variables globals per compatibilitat amb WordPress -->
   <script>
       // Variables globals necessÃ ries per als scripts originals
       var gb_vars = {
           ajaxurl: 'api/ajax.php' // Simulem l'AJAX de WordPress
       };
       
       var mb_vars = {
           ajaxurl: 'api/ajax.php',
           plugin_url: '.',
           dades_plantes: [] // Es carregarÃ  dinÃ micament
       };
       
       // Variable global per a les dades de plantes (per la galeria)
       var gb_plantes_data = [];

       // FunciÃ³ per verificar si les imatges dels marges existeixen
       async function verificarImatgesMarges() {
           const imatgeEsquerra = 'assets/imatges/marge-esquerra.png';
           const imatgeDreta = 'assets/imatges/marge-dreta.png';
           
           try {
               // Test imatge esquerra
               const imgEsq = new Image();
               const promiseEsq = new Promise((resolve) => {
                   imgEsq.onload = () => resolve(true);
                   imgEsq.onerror = () => resolve(false);
                   imgEsq.src = imatgeEsquerra;
               });
               
               // Test imatge dreta
               const imgDreta = new Image();
               const promiseDreta = new Promise((resolve) => {
                   imgDreta.onload = () => resolve(true);
                   imgDreta.onerror = () => resolve(false);
                   imgDreta.src = imatgeDreta;
               });
               
               // Esperar ambdues imatges
               const [esquerraExisteix, dretaExisteix] = await Promise.all([promiseEsq, promiseDreta]);
               
               // Si ambdues imatges existeixen, activar els marges
               if (esquerraExisteix && dretaExisteix) {
                   document.body.classList.add('marges-actius');
                   console.log('âœ… Marges decoratius activats - imatges carregades correctament');
               } else {
                   console.warn('âš ï¸ Marges decoratius desactivats - imatges no trobades');
                   console.log(`Imatge esquerra: ${esquerraExisteix ? 'âœ…' : 'âŒ'}`);
                   console.log(`Imatge dreta: ${dretaExisteix ? 'âœ…' : 'âŒ'}`);
               }
           } catch (error) {
               console.error('Error verificant imatges dels marges:', error);
           }
       }
   </script>
   
   <!-- Scripts originals de WordPress adaptats -->
   <script src="assets/js/galeria-botanica-original.js"></script>
   <script src="assets/js/mapa-botanica-original.js"></script>
   
   <!-- Script d'inicialitzaciÃ³ (DESPRÃ‰S de carregar els altres scripts) -->
   <script>
       // Funcions de navegaciÃ³
       function mostrarInici() {
           document.getElementById('inici-section').style.display = 'block';
           document.getElementById('galeria-section').style.display = 'none';
           document.getElementById('mapa-section').style.display = 'none';
           
           document.getElementById('btn-inici').classList.add('active');
           document.getElementById('btn-galeria').classList.remove('active');
           document.getElementById('btn-mapa').classList.remove('active');
       }

       function mostrarGaleria() {
           document.getElementById('inici-section').style.display = 'none';
           document.getElementById('galeria-section').style.display = 'block';
           document.getElementById('mapa-section').style.display = 'none';
           
           document.getElementById('btn-inici').classList.remove('active');
           document.getElementById('btn-galeria').classList.add('active');
           document.getElementById('btn-mapa').classList.remove('active');
       }

       function mostrarMapa() {
           document.getElementById('inici-section').style.display = 'none';
           document.getElementById('galeria-section').style.display = 'none';
           document.getElementById('mapa-section').style.display = 'block';
           
           document.getElementById('btn-inici').classList.remove('active');
           document.getElementById('btn-galeria').classList.remove('active');
           document.getElementById('btn-mapa').classList.add('active');
           
           // Redimensionar el mapa si ja existeix
           if (window.map) {
               setTimeout(() => window.map.invalidateSize(), 100);
           }
       }
       
       // Processar dades per al mapa (format compatible)
       function processarDadesPerMapa(plantes) {
           return plantes.map(planta => ({
               ...planta,
               imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
               habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
               floracio_norm: planta.caracteristiques?.floracio ? 
                   (Array.isArray(planta.caracteristiques.floracio) ? 
                       planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                       [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
               usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
               floracio: planta.caracteristiques?.floracio ? 
                   (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
               fullatge: planta.caracteristiques?.fullatge || '',
               info_completa: construirInfoCompleta(planta)
           }));
       }
       
       // Construir informaciÃ³ completa per la cerca
       function construirInfoCompleta(planta) {
           let info = [
               planta.nom_comu, 
               planta.nom_cientific, 
               planta.familia, 
               planta.descripcio, 
               planta.tipus
           ];
           
           if (planta.caracteristiques) {
               Object.values(planta.caracteristiques).forEach(valor => {
                   if (Array.isArray(valor)) {
                       info.push(...valor);
                   } else if (valor) {
                       info.push(valor);
                   }
               });
           }
           
           if (planta.usos) {
               const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
               info.push(...usosNetejats);
           }
           
           if (planta.colors) {
               const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
               info.push(...colorsNetejats);
           }
           
           if (planta.habitat) {
               const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
               info.push(...habitatsNetejats);
           }
           
           return info.filter(i => i).join(' ');
       }
       
       // Carregar dades i inicialitzar DESPRÃ‰S que tots els scripts estiguin carregats
       document.addEventListener('DOMContentLoaded', async function() {
           try {
               // Mostrar loading
               document.getElementById('loading-overlay').classList.remove('hidden');
               
               // PRIMER: Verificar imatges dels marges
               verificarImatgesMarges();
               
               // Carregar dades de plantes
               const response = await fetch('dades/plantes.json');
               if (!response.ok) {
                   throw new Error(`Error HTTP: ${response.status}`);
               }
               const data = await response.json();
               
               // USAR NOMÃ‰S EL SISTEMA OPTIMITZAT (ja carregat dins de galeria-botanica-original.js)
               gb_plantes_data = data.plantes || data;
               mb_vars.dades_plantes = processarDadesPerMapa(gb_plantes_data);
               
               console.log('âœ… Dades carregades:', gb_plantes_data.length, 'plantes');
               
               // Esperar que les funcions estiguin disponibles
               let intents = 0;
               const esperarFuncions = () => {
                   if (typeof window.generarGaleriaHTML === 'function' && typeof window.generarMapaHTML === 'function') {
                       // Generar contingut de la galeria (el sistema optimitzat s'activa automÃ ticament aquÃ­)
                       window.generarGaleriaHTML(gb_plantes_data).then(() => {
                           // Generar contingut del mapa
                           return window.generarMapaHTML();
                       }).then(() => {
                           // Amagar loading
                           document.getElementById('loading-overlay').classList.add('hidden');
                           console.log('ğŸ‰ AplicaciÃ³ inicialitzada correctament amb sistema optimitzat');
                       });
                   } else {
                       intents++;
                       if (intents < 50) {
                           setTimeout(esperarFuncions, 100);
                       } else {
                           console.error('No s\'han pogut carregar les funcions necessÃ ries');
                           document.getElementById('loading-overlay').innerHTML = 
                               '<div style="color: red; text-align: center;"><h3>Error carregant l\'aplicaciÃ³</h3><p>Si us plau, recarrega la pÃ gina.</p></div>';
                       }
                   }
               };
               
               esperarFuncions();
               
           } catch (error) {
               console.error('Error carregant dades:', error);
               document.getElementById('loading-overlay').innerHTML = 
                   `<div style="color: red; text-align: center;">
                       <h3>Error carregant les dades</h3>
                       <p>${error.message}</p>
                       <p>Si us plau, recarrega la pÃ gina.</p>
                   </div>`;
           }
       });
   </script>
</body>
</html>
