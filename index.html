<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Bot√†nica UAB</title>
    
    <!-- Leaflet CSS per al mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Estils propis -->
    <link rel="stylesheet" href="assets/css/galeria-botanica.css">
    <link rel="stylesheet" href="assets/css/mapa-botanica.css">
    <link rel="stylesheet" href="assets/css/main.css">
    
    <style>
        /* Estils espec√≠fics per a la pestanya d'inici */
        #inici-section {
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.6;
            color: #333;
            background: #fff;
        }

        .inici-hero {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 2px solid #4CAF50;
        }

        .inici-hero h1 {
            color: #2c5530;
            font-size: 2.5rem;
            margin: 0 0 1rem 0;
            font-weight: 700;
        }

        .inici-hero .subtitol {
            color: #4a7c59;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .inici-hero .descripcio {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 2rem;
        }

        .inici-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 120px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4CAF50;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .inici-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .inici-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .inici-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .inici-card h3 {
            color: #2c5530;
            margin: 0 0 1rem 0;
            font-size: 1.4rem;
        }

        .inici-card p {
            margin: 0.5rem 0;
            color: #555;
        }

        .inici-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .inici-table th {
            background: #4CAF50;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .inici-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .inici-table tr:last-child td {
            border-bottom: none;
        }

        .zones-clau {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .zones-clau h3 {
            color: #2c5530;
            margin: 0 0 1.5rem 0;
            text-align: center;
        }

        .zona-item {
            margin: 1rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #FF9800;
        }

        .zona-nom {
            font-weight: bold;
            color: #2c5530;
            margin-bottom: 0.5rem;
        }

        .caracteristiques-tecniques {
            background: #e8f5e8;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .col-laboracio {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: center;
        }

        .col-laboracio h3 {
            color: white;
            margin-bottom: 1.5rem;
        }

        .col-laboracio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .col-laboracio-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .credits {
            background: #2c5530;
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: center;
        }

        .credits h3 {
            color: #4CAF50;
            margin-bottom: 1rem;
        }

        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 2rem 0;
        }

        .cta-btn {
            padding: 1rem 2rem;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cta-btn:hover {
            background: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .cta-btn.secondary {
            background: #FF9800;
        }

        .cta-btn.secondary:hover {
            background: #F57C00;
        }

        /* Estils per les estad√≠stiques d'imatges */
        .loading-stats {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }

        .loading-stats.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .loading-stats.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #inici-section {
                padding: 1rem;
            }
            
            .inici-hero h1 {
                font-size: 2rem;
            }
            
            .inici-stats {
                gap: 1rem;
            }
            
            .inici-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .col-laboracio-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Galeria Bot√†nica UAB</h1>
            <nav class="app-nav">
                <button onclick="mostrarInici()" class="nav-btn active" id="btn-inici">Inici</button>
                <button onclick="mostrarGaleria()" class="nav-btn" id="btn-galeria">Galeria</button>
                <button onclick="mostrarMapa()" class="nav-btn" id="btn-mapa">Mapa</button>
            </nav>
        </header>

        <main class="app-main">
            <!-- INICI -->
            <div id="inici-section">
                <div class="inici-hero">
                    <h1>üåø Galeria i Mapa Bot√†nica UAB</h1>
                    <div class="subtitol">Descobreix la biodiversitat del campus de la Universitat Aut√≤noma de Barcelona</div>
                    <div class="descripcio">
                        Benvinguts i benvingudes al portal que converteix els <strong>260 ha</strong> de zones verdes de la UAB 
                        en un herbari digital interactiu.
                    </div>
                    
                    <div class="inici-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="stat-especies">250+</span>
                            <span class="stat-label">Esp√®cies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="stat-fotografies">1800+</span>
                            <span class="stat-label">Fotografies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">260</span>
                            <span class="stat-label">Hect√†rees</span>
                        </div>
                    </div>

                    <!-- Estat de c√†rrega d'imatges -->
                    <div id="loading-status" class="loading-stats">
                        üîÑ Carregant imatges des de GitHub...
                    </div>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        üçÉ Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        üó∫Ô∏è Viatja pel Mapa
                    </a>
                </div>

                <div class="inici-grid">
                    <div class="inici-card">
                        <h3>üîç Galeria Bot√†nica</h3>
                        <p>Un cat√†leg visual filtrable amb fotos detallades (flor, fulla, fruit, h√†bit) i fitxa completa.</p>
                        <p><strong>Com t'ajuda:</strong> Identifica esp√®cies r√†pidament amb filtres per color, h√†bitat o √®poca de floraci√≥.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>üó∫Ô∏è Mapa Bot√†nic</h3>
                        <p>Un mapa interactiu amb marcadors geolocalitzats i rutes tem√†tiques que situa cada planta <em>in situ</em>.</p>
                        <p><strong>Com t'ajuda:</strong> Organitza sortides, troba exemplars singulars i segueix itineraris auto-guiats.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>‚ö° Cercador Instantani</h3>
                        <p>Cerca per nom cient√≠fic o vulgar en temps real.</p>
                        <p><strong>Com t'ajuda:</strong> Troba la planta que busques en segons.</p>
                    </div>
                </div>

                <div class="inici-card">
                    <h3>üéØ Per qu√® un cat√†leg bot√†nic del campus?</h3>
                    <p>El campus de Bellaterra √©s molt m√©s que aules i laboratoris: √©s un mosaic de <strong>boscos mediterranis, torrents i camps</strong> que actua de corredor biol√≤gic entre el Mass√≠s de Sant Lloren√ß i Collserola. Documentar-lo t√© tres grans avantatges:</p>
                    
                    <table class="inici-table">
                        <thead>
                            <tr>
                                <th>√Ämbit</th>
                                <th>Com t'ajuda</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>üìö Doc√®ncia</strong></td>
                                <td>Facilita la identificaci√≥ de plantes durant sortides de camp i pr√†ctiques</td>
                            </tr>
                            <tr>
                                <td><strong>üî¨ Ci√®ncia</strong></td>
                                <td>Genera dades fiables per a projectes de recerca i seguiment de biodiversitat</td>
                            </tr>
                            <tr>
                                <td><strong>üå± Divulgaci√≥</strong></td>
                                <td>Apropa la bot√†nica a qualsevol persona que passegi pel campus</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="zones-clau">
                    <h3>üó∫Ô∏è Zones clau per comen√ßar a explorar</h3>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üå≥ Cam√≠ de Ho Chi Minh</div>
                        <div>Alzinar amb arbusts mediterranis i orqu√≠dies de primavera.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üåä Torrent de Can Dom√®nech</div>
                        <div>Vegetaci√≥ de ribera amb salzes, joncs i freixes.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üå∫ Eix Central</div>
                        <div>Arborets ornamentals que combinen esp√®cies aut√≤ctones i ex√≤tiques.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üåæ Rondes del campus</div>
                        <div>Prats oberts ideals per observar floraci√≥ estacional d'herb√†cies.</div>
                    </div>
                </div>

                <div class="caracteristiques-tecniques">
                    <h3>‚öôÔ∏è Com s'ha constru√Øt la plataforma?</h3>
                    <ul>
                        <li><strong>Sistema d'imatges intel¬∑ligent</strong> ‚Äì Les imatges es carreguen autom√†ticament des de GitHub i s'assignen per nom cient√≠fic.</li>
                        <li><strong>API GitHub integrada</strong> ‚Äì Sempre actualitzat amb les √∫ltimes fotografies del repositori.</li>
                        <li><strong>Fitxer √∫nic <code>plantes.json</code></strong> ‚Äì la "font de la veritat" que evita dades duplicades.</li>
                        <li><strong>Leaflet + CSS modern</strong> ‚Äì mapa lleuger i disseny adaptat a m√≤bil i escriptori.</li>
                        <li><strong>Llic√®ncia MIT</strong> ‚Äì pots forquejar, millorar o portar el projecte al teu entorn.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>üë• A qui va dirigit?</h3>
                    <ul>
                        <li><strong>Estudiantat de Biologia, Ci√®ncies Ambientals i Educaci√≥</strong> ‚Äì recurs per a pr√†ctiques i TFG/TFM.</li>
                        <li><strong>Professorat</strong> ‚Äì material did√†ctic per a classes i sortides.</li>
                        <li><strong>Investigadors/es</strong> ‚Äì punt de partida per a estudis de biodiversitat local.</li>
                        <li><strong>P√∫blic general</strong> ‚Äì eina per gaudir i entendre la natura del campus.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>üöÄ Plans de futur</h3>
                    <ol>
                        <li><strong>Miniatures WebP</strong> per accelerar encara m√©s la galeria.</li>
                        <li><strong>API REST</strong> perqu√® aplicacions m√≤bils (p. ex. Planttes) consumeixin dades en temps real.</li>
                        <li><strong>Versi√≥ PWA</strong> amb funcionalitat offline completa.</li>
                        <li><strong>Traducci√≥ multiling√ºe</strong> per compartir el recurs amb estudiants internacionals.</li>
                        <li><strong>Nous camps</strong>: pol¬∑linitzadors, estatus de protecci√≥ i fenologia mensual.</li>
                    </ol>
                </div>

                <div class="col-laboracio">
                    <h3>ü§ù Com pots col¬∑laborar?</h3>
                    
                    <div class="col-laboracio-grid">
                        <div class="col-laboracio-item">
                            <strong>üì∏ Afegir dades o fotos</strong><br>
                            Obre un <em>Pull Request</em> o puja una <em>Issue</em> amb la teva proposta.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üêõ Reportar un error</strong><br>
                            Indica la planta, captura de pantalla i pas a pas per reproduir-lo.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üåç Traduir la interf√≠cie</strong><br>
                            Crea un fitxer a <code>/lang</code> seguint l'estructura JSON existent.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üö∂ Organitzar una sortida guiada</strong><br>
                            Escriu a <a href="mailto:botanica@uab.cat" style="color: #E8F5E8;">botanica@uab.cat</a>
                        </div>
                    </div>
                </div>

                <div class="credits">
                    <h3>üë®‚Äçüéì Cr√®dits</h3>
                    <p>Projecte desenvolupat com a <strong>Treball de Fi de Grau</strong> a la Facultat de Bioci√®ncies de la UAB.</p>
                    <p><strong>Autor:</strong> <em>Tom√°s Gonz√°lez Bartomeu</em></p>
                    <p><strong>Tutor acad√®mic:</strong> <em>Ramon P√©rez Obiol</em></p>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        üçÉ Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        üó∫Ô∏è Viatja pel Mapa
                    </a>
                </div>

                <div style="text-align: center; margin: 2rem 0; color: #4CAF50; font-size: 1.2rem; font-weight: 600;">
                    üå± Ajuda'ns a fer cr√©ixer el coneixement de la flora local!
                </div>
            </div>

            <!-- GALERIA -->
            <div id="galeria-section" class="galeria-botanica" style="display: none;">
                <!-- Els filtres i la graella es generaran din√†micament amb JS -->
            </div>

            <!-- MAPA -->
            <div id="mapa-section" class="mapa-botanica-contenidor" style="display: none;">
                <!-- Els filtres del mapa es generaran din√†micament -->
            </div>
        </main>

        <!-- Modal per detalls -->
        <div class="planta-modal" style="display: none;">
            <div class="planta-modal-contingut">
                <span class="planta-modal-tancar">&times;</span>
                <div class="planta-modal-cos"></div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Carregant galeria bot√†nica...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    
    <!-- Variables globals per compatibilitat amb WordPress -->
    <script>
        // Variables globals necess√†ries per als scripts originals
        var gb_vars = {
            ajaxurl: 'api/ajax.php' // Simulem l'AJAX de WordPress
        };
        
        var mb_vars = {
            ajaxurl: 'api/ajax.php',
            plugin_url: '.',
            dades_plantes: [] // Es carregar√† din√†micament
        };
        
        // Variable global per a les dades de plantes (per la galeria)
        var gb_plantes_data = [];
    </script>
    
    <!-- Nou sistema d'imatges amb GitHub -->
    <script>
        /**
         * Sistema d'Imatges Millorat - UAB Galeria Bot√†nica
         * Utilitza l'API de GitHub per obtenir la llista real d'imatges
         * i les agrupa eficientment per nom cient√≠fic
         */

        class SistemaImatgesGitHub {
            constructor() {
                this.imatgesDisponibles = new Map(); // nom_cientific -> array d'objectes imatge
                this.tipusEstructures = ['flor', 'fulla', 'fruit', 'tija', 'habit', 'altre'];
                this.repositori = {
                    owner: 'PoltorProgrammer',
                    repo: 'TFG_Galeria_Botanica_Maig_2025',
                    path: 'assets/imatges'
                };
                this.cacheImatges = null; // Cache per evitar peticions repetides
            }

            /**
             * Obt√© la llista completa d'imatges del repositori GitHub
             */
            async obtenirLlistaImatges() {
                if (this.cacheImatges) {
                    console.log('Utilitzant cache d\'imatges...');
                    return this.cacheImatges;
                }

                try {
                    console.log('Carregant llista d\'imatges des de GitHub...');
                    
                    const url = `https://api.github.com/repos/${this.repositori.owner}/${this.repositori.repo}/contents/${this.repositori.path}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Error API GitHub: ${response.status} ${response.statusText}`);
                    }
                    
                    const files = await response.json();
                    
                    // Filtrar nom√©s els fitxers .jpg i .jpeg
                    const imatges = files
                        .filter(file => file.type === 'file' && /\.(jpg|jpeg)$/i.test(file.name))
                        .map(file => ({
                            nom: file.name,
                            url: file.download_url,
                            mida: file.size
                        }));
                    
                    this.cacheImatges = imatges;
                    console.log(`Trobades ${imatges.length} imatges al repositori`);
                    
                    return imatges;
                    
                } catch (error) {
                    console.error('Error obtenint llista d\'imatges:', error);
                    
                    // Fallback: intentar amb una llista predefinida o retornar array buit
                    console.warn('Utilitzant mode fallback sense imatges de GitHub');
                    return [];
                }
            }

            /**
             * Converteix nom cient√≠fic al format utilitzat en els noms de fitxer
             */
            nomCientificAFitxer(nomCientific) {
                return nomCientific.toLowerCase()
                                  .replace(/\s+/g, '_')           // Espais -> guions baixos
                                  .replace(/[^a-z0-9_]/g, '')     // Nom√©s lletres, n√∫meros i _
                                  .trim();
            }

            /**
             * Extreu informaci√≥ d'un nom de fitxer d'imatge
             * Format esperat: {nom_cientific}_{numero}_{estructura}.jpg
             */
            analitzarNomFitxer(nomFitxer) {
                // Eliminar extensi√≥
                const sensExtensio = nomFitxer.replace(/\.(jpg|jpeg)$/i, '');
                
                // Dividir per guions baixos
                const parts = sensExtensio.split('_');
                
                if (parts.length < 3) {
                    console.warn(`Format de fitxer no reconegut: ${nomFitxer}`);
                    return null;
                }
                
                // L'estructura √©s l'√∫ltima part
                const estructura = parts[parts.length - 1].toLowerCase();
                
                // El n√∫mero √©s la pen√∫ltima part
                const numeroStr = parts[parts.length - 2];
                const numero = parseInt(numeroStr, 10);
                
                // El nom cient√≠fic s√≥n totes les parts menys les dues √∫ltimes
                const nomCientific = parts.slice(0, -2).join('_');
                
                // Validar estructura
                if (!this.tipusEstructures.includes(estructura)) {
                    console.warn(`Estructura no reconeguda '${estructura}' en: ${nomFitxer}`);
                }
                
                // Validar n√∫mero
                if (isNaN(numero)) {
                    console.warn(`N√∫mero no v√†lid '${numeroStr}' en: ${nomFitxer}`);
                }
                
                return {
                    nomCientificFitxer: nomCientific,
                    numero: numero,
                    estructura: estructura,
                    nomFitxerOriginal: nomFitxer
                };
            }

            /**
             * Agrupa les imatges per nom cient√≠fic
             */
            async agruparImatgesPerEspecie(llistaImatges, plantesJSON) {
                console.log('Agrupant imatges per esp√®cie...');
                
                // Crear mapa de noms cient√≠fics del JSON per comparaci√≥
                const nomsCientificsJSON = new Set();
                plantesJSON.forEach(planta => {
                    const nomNormalitzat = this.nomCientificAFitxer(planta.nom_cientific);
                    nomsCientificsJSON.add(nomNormalitzat);
                });
                
                // Analitzar cada imatge i agrupar-la
                const agrupacio = new Map();
                let imatgesProcessades = 0;
                let imatgesIgnorades = 0;
                
                for (const imatge of llistaImatges) {
                    const info = this.analitzarNomFitxer(imatge.nom);
                    
                    if (!info) {
                        imatgesIgnorades++;
                        continue;
                    }
                    
                    // Verificar si aquesta esp√®cie existeix al JSON
                    if (!nomsCientificsJSON.has(info.nomCientificFitxer)) {
                        console.debug(`Imatge ignorada (esp√®cie no al JSON): ${imatge.nom}`);
                        imatgesIgnorades++;
                        continue;
                    }
                    
                    // Afegir a l'agrupaci√≥
                    if (!agrupacio.has(info.nomCientificFitxer)) {
                        agrupacio.set(info.nomCientificFitxer, []);
                    }
                    
                    agrupacio.get(info.nomCientificFitxer).push({
                        nomFitxer: imatge.nom,
                        urlCompleta: `assets/imatges/${imatge.nom}`, // Ruta local
                        urlGitHub: imatge.url, // URL directa de GitHub (backup)
                        numero: info.numero,
                        estructura: info.estructura,
                        mida: imatge.mida
                    });
                    
                    imatgesProcessades++;
                }
                
                // Ordenar imatges dins de cada esp√®cie per n√∫mero
                agrupacio.forEach((imatges, especie) => {
                    imatges.sort((a, b) => a.numero - b.numero);
                });
                
                console.log(`Agrupaci√≥ completada:`);
                console.log(`- ${imatgesProcessades} imatges processades`);
                console.log(`- ${imatgesIgnorades} imatges ignorades`);
                console.log(`- ${agrupacio.size} esp√®cies amb imatges`);
                
                this.imatgesDisponibles = agrupacio;
                return agrupacio;
            }

            /**
             * Assigna imatges a una planta espec√≠fica
             */
            assignarImatgesPlanta(planta) {
                const nomNormalitzat = this.nomCientificAFitxer(planta.nom_cientific);
                const imatgesEspecie = this.imatgesDisponibles.get(nomNormalitzat) || [];
                
                if (imatgesEspecie.length === 0) {
                    console.debug(`No hi ha imatges per: ${planta.nom_cientific}`);
                    return {
                        principal: null,
                        principal_tipus: 'general',
                        detalls: [],
                        detalls_tipus: []
                    };
                }
                
                // Prioritzar per a la imatge principal: flor > habit > fulla > fruit > tija > altre
                const prioritatEstructures = {
                    'flor': 1,
                    'habit': 2, 
                    'fulla': 3,
                    'fruit': 4,
                    'tija': 5,
                    'altre': 6
                };
                
                // Trobar la millor imatge per a principal
                const imatgesSorted = [...imatgesEspecie].sort((a, b) => {
                    const prioritatA = prioritatEstructures[a.estructura] || 999;
                    const prioritatB = prioritatEstructures[b.estructura] || 999;
                    
                    if (prioritatA !== prioritatB) {
                        return prioritatA - prioritatB;
                    }
                    
                    // Si mateix tipus, prioritzar per n√∫mero m√©s baix
                    return a.numero - b.numero;
                });
                
                const principal = imatgesSorted[0];
                const detalls = imatgesSorted.slice(1);
                
                const resultat = {
                    principal: principal.nomFitxer,
                    principal_tipus: principal.estructura,
                    detalls: detalls.map(img => img.nomFitxer),
                    detalls_tipus: detalls.map(img => img.estructura)
                };
                
                console.debug(`Assignades ${1 + detalls.length} imatges a: ${planta.nom_cientific}`);
                return resultat;
            }

            /**
             * Actualitzar l'estat visual del carregament
             */
            actualitzarEstatCarregament(missatge, tipus = 'loading') {
                const elementEstat = document.getElementById('loading-status');
                if (elementEstat) {
                    elementEstat.textContent = missatge;
                    elementEstat.className = `loading-stats ${tipus}`;
                }
            }

            /**
             * Processar totes les plantes del JSON
             */
            async processarTotesLesPlantes(plantesJSON) {
                try {
                    console.log('=== INICI PROCESSAMENT D\'IMATGES ===');
                    this.actualitzarEstatCarregament('üîÑ Obtenint llista d\'imatges des de GitHub...');
                    
                    // 1. Obtenir llista d'imatges des de GitHub
                    const llistaImatges = await this.obtenirLlistaImatges();
                    
                    if (llistaImatges.length === 0) {
                        console.warn('No s\'han trobat imatges. Continuant sense imatges...');
                        this.actualitzarEstatCarregament('‚ö†Ô∏è No s\'han trobat imatges al repositori', 'error');
                        return plantesJSON.map(planta => ({
                            ...planta,
                            imatges: {
                                principal: null,
                                principal_tipus: 'general',
                                detalls: [],
                                detalls_tipus: []
                            }
                        }));
                    }
                    
                    this.actualitzarEstatCarregament(`üîç Agrupant ${llistaImatges.length} imatges per esp√®cie...`);
                    
                    // 2. Agrupar imatges per esp√®cie
                    await this.agruparImatgesPerEspecie(llistaImatges, plantesJSON);
                    
                    this.actualitzarEstatCarregament('üìù Assignant imatges a cada planta...');
                    
                    // 3. Assignar imatges a cada planta
                    const plantesAmbImatges = plantesJSON.map(planta => ({
                        ...planta,
                        imatges: this.assignarImatgesPlanta(planta)
                    }));
                    
                    // 4. Estad√≠stiques finals
                    const plantesAmbImatgePrincipal = plantesAmbImatges.filter(p => p.imatges.principal !== null);
                    const totalImatges = plantesAmbImatges.reduce((total, p) => 
                        total + (p.imatges.principal ? 1 : 0) + p.imatges.detalls.length, 0);
                    
                    // 5. Actualitzar estad√≠stiques a la interf√≠cie
                    const estatEspecies = document.getElementById('stat-especies');
                    const estatFotografies = document.getElementById('stat-fotografies');
                    
                    if (estatEspecies) {
                        estatEspecies.textContent = plantesJSON.length;
                    }
                    if (estatFotografies) {
                        estatFotografies.textContent = totalImatges;
                    }
                    
                    console.log('=== RESULTAT FINAL ===');
                    console.log(`- ${plantesJSON.length} plantes processades`);
                    console.log(`- ${plantesAmbImatgePrincipal.length} plantes amb imatge principal`);
                    console.log(`- ${totalImatges} imatges assignades en total`);
                    console.log('=========================');
                    
                    this.actualitzarEstatCarregament(
                        `‚úÖ ${plantesAmbImatgePrincipal.length}/${plantesJSON.length} plantes amb imatges (${totalImatges} fotografies)`, 
                        'success'
                    );
                    
                    return plantesAmbImatges;
                    
                } catch (error) {
                    console.error('Error processant imatges:', error);
                    this.actualitzarEstatCarregament(`‚ùå Error carregant imatges: ${error.message}`, 'error');
                    
                    // Retornar plantes sense imatges en cas d'error
                    return plantesJSON.map(planta => ({
                        ...planta,
                        imatges: {
                            principal: null,
                            principal_tipus: 'general', 
                            detalls: [],
                            detalls_tipus: []
                        }
                    }));
                }
            }

            /**
             * Obtenir estad√≠stiques sobre les imatges disponibles
             */
            obtenirEstadistiques() {
                if (!this.imatgesDisponibles || this.imatgesDisponibles.size === 0) {
                    return {
                        especiesAmbImatges: 0,
                        totalImatges: 0,
                        estructuresDisponibles: [],
                        imatgePerEstructura: {}
                    };
                }
                
                let totalImatges = 0;
                const estructuresCount = {};
                
                this.imatgesDisponibles.forEach((imatges, especie) => {
                    totalImatges += imatges.length;
                    
                    imatges.forEach(img => {
                        estructuresCount[img.estructura] = (estructuresCount[img.estructura] || 0) + 1;
                    });
                });
                
                return {
                    especiesAmbImatges: this.imatgesDisponibles.size,
                    totalImatges: totalImatges,
                    estructuresDisponibles: Object.keys(estructuresCount),
                    imatgePerEstructura: estructuresCount
                };
            }
        }

        // Fer accessible globalment
        window.SistemaImatgesGitHub = SistemaImatgesGitHub;
    </script>
    
    <!-- Scripts originals de WordPress adaptats -->
    <script src="assets/js/galeria-botanica-original.js"></script>
    <script src="assets/js/mapa-botanica-original.js"></script>
    
    <!-- Script d'inicialitzaci√≥ (DESPR√âS de carregar els altres scripts) -->
    <script>        
        // Funcions de navegaci√≥
        function mostrarInici() {
            document.getElementById('inici-section').style.display = 'block';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.add('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarGaleria() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'block';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.add('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarMapa() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'block';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.add('active');
            
            // Redimensionar el mapa si ja existeix
            if (window.map) {
                setTimeout(() => window.map.invalidateSize(), 100);
            }
        }
        
        // Processar dades per al mapa (format compatible)
        function processarDadesPerMapa(plantes) {
            return plantes.map(planta => ({
                ...planta,
                imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
                habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio_norm: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? 
                        planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                        [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
                usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
                fullatge: planta.caracteristiques?.fullatge || '',
                info_completa: construirInfoCompleta(planta)
            }));
        }
        
        // Construir informaci√≥ completa per la cerca
        function construirInfoCompleta(planta) {
            let info = [
                planta.nom_comu, 
                planta.nom_cientific, 
                planta.familia, 
                planta.descripcio, 
                planta.tipus
            ];
            
            if (planta.caracteristiques) {
                Object.values(planta.caracteristiques).forEach(valor => {
                    if (Array.isArray(valor)) {
                        info.push(...valor);
                    } else if (valor) {
                        info.push(valor);
                    }
                });
            }
            
            if (planta.usos) {
                const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...usosNetejats);
            }
            
            if (planta.colors) {
                const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...colorsNetejats);
            }
            
            if (planta.habitat) {
                const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...habitatsNetejats);
            }
            
            return info.filter(i => i).join(' ');
        }
        
        // Carregar dades i inicialitzar DESPR√âS que tots els scripts estiguin carregats
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Mostrar loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // Carregar dades de plantes
                const response = await fetch('dades/plantes.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Assignar imatges autom√†ticament amb el nou sistema
                const sistemaImatges = new SistemaImatgesGitHub();
                const plantesAmbImatges = await sistemaImatges.processarTotesLesPlantes(data.plantes || data);
                
                // Assignar a variables globals
                gb_plantes_data = plantesAmbImatges;
                mb_vars.dades_plantes = processarDadesPerMapa(plantesAmbImatges);
                
                console.log('Dades carregades:', plantesAmbImatges.length, 'plantes amb imatges');
                
                // Esperar que les funcions estiguin disponibles
                let intents = 0;
                const esperarFuncions = () => {
                    if (typeof window.generarGaleriaHTML === 'function' && typeof window.generarMapaHTML === 'function') {
                        // Generar contingut de la galeria
                        window.generarGaleriaHTML(plantesAmbImatges).then(() => {
                            // Generar contingut del mapa
                            return window.generarMapaHTML();
                        }).then(() => {
                            // Amagar loading
                            document.getElementById('loading-overlay').classList.add('hidden');
                            console.log('Aplicaci√≥ inicialitzada correctament');
                        });
                    } else {
                        intents++;
                        if (intents < 50) { // M√†xim 5 segons d'espera
                            setTimeout(esperarFuncions, 100);
                        } else {
                            console.error('No s\'han pogut carregar les funcions necess√†ries');
                            document.getElementById('loading-overlay').innerHTML = 
                                '<div style="color: red; text-align: center;"><h3>Error carregant l\'aplicaci√≥</h3><p>Si us plau, recarrega la p√†gina.</p></div>';
                        }
                    }
                };
                
                esperarFuncions();
                
            } catch (error) {
                console.error('Error carregant dades:', error);
                document.getElementById('loading-overlay').innerHTML = 
                    `<div style="color: red; text-align: center;">
                        <h3>Error carregant les dades</h3>
                        <p>${error.message}</p>
                        <p>Si us plau, recarrega la p√†gina.</p>
                    </div>`;
            }
        });
    </script>
</body>
</html>
