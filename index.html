<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Bot√†nica UAB</title>
    
    <!-- Leaflet CSS per al mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Estils propis -->
    <link rel="stylesheet" href="assets/css/galeria-botanica.css">
    <link rel="stylesheet" href="assets/css/mapa-botanica.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Galeria Bot√†nica UAB</h1>
            <nav class="app-nav">
                <button onclick="mostrarInici()" class="nav-btn active" id="btn-inici">Inici</button>
                <button onclick="mostrarGaleria()" class="nav-btn" id="btn-galeria">Galeria</button>
                <button onclick="mostrarMapa()" class="nav-btn" id="btn-mapa">Mapa</button>
            </nav>
        </header>

        <main class="app-main">
            <!-- INICI -->
            <div id="inici-section">
                <div class="inici-hero">
                    <h1>üåø Galeria i Mapa Bot√†nica UAB</h1>
                    <div class="subtitol">Descobreix la biodiversitat del campus de la Universitat Aut√≤noma de Barcelona</div>
                    <div class="descripcio">
                        Benvinguts i benvingudes al portal que converteix els <strong>260 ha</strong> de zones verdes de la UAB 
                        en un herbari digital interactiu.
                    </div>
                    
                    <div class="inici-stats">
                        <div class="stat-item">
                            <span class="stat-number">300+</span>
                            <span class="stat-label">Esp√®cies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">1800+</span>
                            <span class="stat-label">Fotografies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">260</span>
                            <span class="stat-label">Hect√†rees</span>
                        </div>
                    </div>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        üçÉ Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        üó∫Ô∏è Viatja pel Mapa
                    </a>
                </div>

                <div class="inici-grid">
                    <div class="inici-card">
                        <h3>üîç Galeria Bot√†nica</h3>
                        <p>Un cat√†leg visual filtrable amb fotos detallades (flor, fulla, fruit, h√†bit) i fitxa completa.</p>
                        <p><strong>Com t'ajuda:</strong> Identifica esp√®cies r√†pidament amb filtres per color, h√†bitat o √®poca de floraci√≥.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>üó∫Ô∏è Mapa Bot√†nic</h3>
                        <p>Un mapa interactiu amb marcadors geolocalitzats i rutes tem√†tiques que situa cada planta <em>in situ</em>.</p>
                        <p><strong>Com t'ajuda:</strong> Organitza sortides, troba exemplars singulars i segueix itineraris auto-guiats.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>‚ö° Cercador Instantani</h3>
                        <p>Cerca per nom cient√≠fic o vulgar en temps real.</p>
                        <p><strong>Com t'ajuda:</strong> Troba la planta que busques en segons.</p>
                    </div>
                </div>

                <div class="inici-card">
                    <h3>üéØ Per qu√® un cat√†leg bot√†nic del campus?</h3>
                    <p>El campus de Bellaterra √©s molt m√©s que aules i laboratoris: √©s un mosaic de <strong>boscos mediterranis, torrents i camps</strong> que actua de corredor biol√≤gic entre el Mass√≠s de Sant Lloren√ß i Collserola. Documentar-lo t√© tres grans avantatges:</p>
                    
                    <table class="inici-table">
                        <thead>
                            <tr>
                                <th>√Ämbit</th>
                                <th>Com t'ajuda</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>üìö Doc√®ncia</strong></td>
                                <td>Facilita la identificaci√≥ de plantes durant sortides de camp i pr√†ctiques</td>
                            </tr>
                            <tr>
                                <td><strong>üî¨ Ci√®ncia</strong></td>
                                <td>Genera dades fiables per a projectes de recerca i seguiment de biodiversitat</td>
                            </tr>
                            <tr>
                                <td><strong>üå± Divulgaci√≥</strong></td>
                                <td>Apropa la bot√†nica a qualsevol persona que passegi pel campus</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="zones-clau">
                    <h3>üó∫Ô∏è Zones clau per comen√ßar a explorar</h3>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üå≥ Cam√≠ de Ho Chi Minh</div>
                        <div>Alzinar amb arbusts mediterranis i orqu√≠dies de primavera.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üåä Torrent de Can Dom√®nech</div>
                        <div>Vegetaci√≥ de ribera amb salzes, joncs i freixes.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üå∫ Eix Central</div>
                        <div>Arborets ornamentals que combinen esp√®cies aut√≤ctones i ex√≤tiques.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">üåæ Rondes del campus</div>
                        <div>Prats oberts ideals per observar floraci√≥ estacional d'herb√†cies.</div>
                    </div>
                </div>

                <div class="caracteristiques-tecniques">
                    <h3>‚öôÔ∏è Com s'ha constru√Øt la plataforma?</h3>
                    <ul>
                        <li><strong>Plugin de WordPress</strong> 100% codi obert ‚Äì dos <em>shortcodes</em> carreguen la galeria i el mapa.</li>
                        <li><strong>Fitxer √∫nic <code>plantes.json</code></strong> ‚Äì la "font de la veritat" que evita dades duplicades.</li>
                        <li><strong>Leaflet + Tailwind</strong> ‚Äì mapa lleuger i disseny adaptat a m√≤bil i escriptori.</li>
                        <li><strong>Editor offline integrat</strong> ‚Äì afegeix o edita esp√®cies sense tocar codi gr√†cies a la File System Access API (opcional).</li>
                        <li><strong>Llic√®ncia MIT</strong> ‚Äì pots forquejar, millorar o portar el projecte al teu entorn.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>üë• A qui va dirigit?</h3>
                    <ul>
                        <li><strong>Estudiantat de Biologia, Ci√®ncies Ambientals i Educaci√≥</strong> ‚Äì recurs per a pr√†ctiques i TFG/TFM.</li>
                        <li><strong>Professorat</strong> ‚Äì material did√†ctic per a classes i sortides.</li>
                        <li><strong>Investigadors/es</strong> ‚Äì punt de partida per a estudis de biodiversitat local.</li>
                        <li><strong>P√∫blic general</strong> ‚Äì eina per gaudir i entendre la natura del campus.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>üöÄ Plans de futur</h3>
                    <ol>
                        <li><strong>Miniatures WebP</strong> per accelerar encara m√©s la galeria.</li>
                        <li><strong>API REST</strong> perqu√® aplicacions m√≤bils (p. ex. Planttes) consumeixin dades en temps real.</li>
                        <li><strong>Versi√≥ PWA</strong> amb funcionalitat offline completa.</li>
                        <li><strong>Traducci√≥ multiling√ºe</strong> per compartir el recurs amb estudiants internacionals.</li>
                        <li><strong>Nous camps</strong>: pol¬∑linitzadors, estatus de protecci√≥ i fenologia mensual.</li>
                    </ol>
                </div>

                <div class="col-laboracio">
                    <h3>ü§ù Com pots col¬∑laborar?</h3>
                    
                    <div class="col-laboracio-grid">
                        <div class="col-laboracio-item">
                            <strong>üì∏ Afegir dades o fotos</strong><br>
                            Obre un <em>Pull Request</em> o puja una <em>Issue</em> amb la teva proposta.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üêõ Reportar un error</strong><br>
                            Indica la planta, captura de pantalla i pas a pas per reproduir-lo.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üåç Traduir la interf√≠cie</strong><br>
                            Crea un fitxer a <code>/lang</code> seguint l'estructura JSON existent.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>üö∂ Organitzar una sortida guiada</strong><br>
                            Escriu a <a href="mailto:botanica@uab.cat" style="color: #E8F5E8;">botanica@uab.cat</a>
                        </div>
                    </div>
                </div>

                <div class="credits">
                    <h3>üë®‚Äçüéì Cr√®dits</h3>
                    <p>Projecte desenvolupat com a <strong>Treball de Fi de Grau</strong> a la Facultat de Bioci√®ncies de la UAB.</p>
                    <p><strong>Autor:</strong> <em>Tom√°s Gonz√°lez Bartomeu</em></p>
                    <p><strong>Tutor acad√®mic:</strong> <em>Ramon P√©rez Obiol</em></p>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        üçÉ Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        üó∫Ô∏è Viatja pel Mapa
                    </a>
                </div>

                <div style="text-align: center; margin: 2rem 0; color: #4CAF50; font-size: 1.2rem; font-weight: 600;">
                    üå± Ajuda'ns a fer cr√©ixer el coneixement de la flora local!
                </div>
            </div>

            <!-- GALERIA -->
            <div id="galeria-section" class="galeria-botanica" style="display: none;">
                <!-- Els filtres i la graella es generaran din√†micament amb JS -->
            </div>

            <!-- MAPA -->
            <div id="mapa-section" class="mapa-botanica-contenidor" style="display: none;">
                <!-- Els filtres del mapa es generaran din√†micament -->
            </div>
        </main>

        <!-- Modal per detalls -->
        <div class="planta-modal" style="display: none;">
            <div class="planta-modal-contingut">
                <span class="planta-modal-tancar">&times;</span>
                <div class="planta-modal-cos"></div>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p>Carregant galeria bot√†nica...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    
    <!-- Variables globals per compatibilitat amb WordPress -->
    <script>
        // Variables globals necess√†ries per als scripts originals
        var gb_vars = {
            ajaxurl: 'api/ajax.php' // Simulem l'AJAX de WordPress
        };
        
        var mb_vars = {
            ajaxurl: 'api/ajax.php',
            plugin_url: '.',
            dades_plantes: [] // Es carregar√† din√†micament
        };
        
        // Variable global per a les dades de plantes (per la galeria)
        var gb_plantes_data = [];

        // Funci√≥ per verificar si les imatges dels marges existeixen
        async function verificarImatgesMarges() {
            const imatgeEsquerra = 'assets/imatges/marge-esquerra.png';
            const imatgeDreta = 'assets/imatges/marge-dreta.png';
            
            try {
                // Test imatge esquerra
                const imgEsq = new Image();
                const promiseEsq = new Promise((resolve) => {
                    imgEsq.onload = () => resolve(true);
                    imgEsq.onerror = () => resolve(false);
                    imgEsq.src = imatgeEsquerra;
                });
                
                // Test imatge dreta
                const imgDreta = new Image();
                const promiseDreta = new Promise((resolve) => {
                    imgDreta.onload = () => resolve(true);
                    imgDreta.onerror = () => resolve(false);
                    imgDreta.src = imatgeDreta;
                });
                
                // Esperar ambdues imatges
                const [esquerraExisteix, dretaExisteix] = await Promise.all([promiseEsq, promiseDreta]);
                
                // Si ambdues imatges existeixen, activar els marges
                if (esquerraExisteix && dretaExisteix) {
                    document.body.classList.add('marges-actius');
                    console.log('‚úÖ Marges decoratius activats - imatges carregades correctament');
                } else {
                    console.warn('‚ö†Ô∏è Marges decoratius desactivats - imatges no trobades');
                    console.log(`Imatge esquerra: ${esquerraExisteix ? '‚úÖ' : '‚ùå'}`);
                    console.log(`Imatge dreta: ${dretaExisteix ? '‚úÖ' : '‚ùå'}`);
                }
            } catch (error) {
                console.error('Error verificant imatges dels marges:', error);
            }
        }
    </script>
    
    <!-- Scripts originals de WordPress adaptats -->
    <script src="assets/js/galeria-botanica-original.js"></script>
    <script src="assets/js/mapa-botanica-original.js"></script>
    
    <!-- Script d'inicialitzaci√≥ (DESPR√âS de carregar els altres scripts) -->
    <script>
        // Sistema per assignar imatges autom√†ticament
        class SistemaImatges {
            constructor() {
                this.imatgesDisponibles = new Map(); // Mapa de nom_cientific -> llista d'imatges
                this.tipusImatges = {
                    'flor': 'flor',
                    'fulla': 'fulla', 
                    'fruit': 'fruit',
                    'tija': 'tija',
                    'habit': 'habit',
                    'altre': 'altre'
                };
            }

            // Convertir nom cient√≠fic a format de fitxer
            nomCientificAFitxer(nomCientific) {
                return nomCientific.toLowerCase()
                                  .replace(/\s+/g, '_')
                                  .replace(/[^a-z0-9_]/g, '');
            }

            // Generar llista de possibles noms d'imatges per una planta
            generarPossiblesImatges(nomCientific) {
                const nomFitxer = this.nomCientificAFitxer(nomCientific);
                const possiblesImatges = [];
                
                // Generar possibles noms per n√∫meros 00-20 i tots els tipus
                for (let num = 0; num <= 20; num++) {
                    const numStr = num.toString().padStart(2, '0');
                    Object.keys(this.tipusImatges).forEach(tipus => {
                        possiblesImatges.push(`${nomFitxer}_${numStr}_${tipus}.jpg`);
                    });
                }
                
                return possiblesImatges;
            }

            // Verificar si una imatge existeix (usant una t√®cnica que no generi errors 404)
            async verificarImatgeExisteix(rutaImatge) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = rutaImatge;
                });
            }

            // Trobar totes les imatges disponibles per una planta
            async trobarImatgesPlanta(nomCientific) {
                const possiblesImatges = this.generarPossiblesImatges(nomCientific);
                const imatgesTrobades = [];
                
                // Crear promeses per verificar totes les imatges en paral¬∑lel
                const verificacions = possiblesImatges.map(async (nomImatge) => {
                    const rutaCompleta = `assets/imatges/${nomImatge}`;
                    const existeix = await this.verificarImatgeExisteix(rutaCompleta);
                    
                    if (existeix) {
                        // Extreure informaci√≥ del nom del fitxer
                        const parts = nomImatge.replace('.jpg', '').split('_');
                        const numero = parts[parts.length - 2];
                        const tipus = parts[parts.length - 1];
                        
                        return {
                            nom: nomImatge,
                            ruta: rutaCompleta,
                            numero: parseInt(numero),
                            tipus: tipus
                        };
                    }
                    return null;
                });
                
                // Esperar totes les verificacions
                const resultats = await Promise.all(verificacions);
                
                // Filtrar nulls i ordenar per n√∫mero
                return resultats.filter(img => img !== null)
                               .sort((a, b) => a.numero - b.numero);
            }

            // Assignar imatges a una planta
            async assignarImatgesPlanta(planta) {
                console.log(`Buscant imatges per: ${planta.nom_cientific}`);
                
                const imatgesTrobades = await this.trobarImatgesPlanta(planta.nom_cientific);
                
                if (imatgesTrobades.length === 0) {
                    console.warn(`No s'han trobat imatges per: ${planta.nom_cientific}`);
                    return {
                        principal: null,
                        principal_tipus: 'general',
                        detalls: [],
                        detalls_tipus: []
                    };
                }
                
                console.log(`Trobades ${imatgesTrobades.length} imatges per: ${planta.nom_cientific}`);
                
                // Assignar la primera imatge com a principal
                const principal = imatgesTrobades[0];
                
                // La resta com a detalls
                const detalls = imatgesTrobades.slice(1);
                
                return {
                    principal: principal.nom,
                    principal_tipus: principal.tipus,
                    detalls: detalls.map(img => img.nom),
                    detalls_tipus: detalls.map(img => img.tipus)
                };
            }

            // Processar totes les plantes del JSON
            async processarTotesLesPlantes(plantes) {
                console.log('Iniciant assignaci√≥ autom√†tica d\'imatges...');
                const plantesAmbImatges = [];
                
                for (const planta of plantes) {
                    const imatges = await this.assignarImatgesPlanta(planta);
                    plantesAmbImatges.push({
                        ...planta,
                        imatges: imatges
                    });
                }
                
                console.log('Assignaci√≥ d\'imatges completada!');
                return plantesAmbImatges;
            }
        }
        
        // Funcions de navegaci√≥
        function mostrarInici() {
            document.getElementById('inici-section').style.display = 'block';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.add('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarGaleria() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'block';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.add('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarMapa() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'block';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.add('active');
            
            // Redimensionar el mapa si ja existeix
            if (window.map) {
                setTimeout(() => window.map.invalidateSize(), 100);
            }
        }
        
        // Processar dades per al mapa (format compatible)
        function processarDadesPerMapa(plantes) {
            return plantes.map(planta => ({
                ...planta,
                imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
                habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio_norm: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? 
                        planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                        [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
                usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
                fullatge: planta.caracteristiques?.fullatge || '',
                info_completa: construirInfoCompleta(planta)
            }));
        }
        
        // Construir informaci√≥ completa per la cerca
        function construirInfoCompleta(planta) {
            let info = [
                planta.nom_comu, 
                planta.nom_cientific, 
                planta.familia, 
                planta.descripcio, 
                planta.tipus
            ];
            
            if (planta.caracteristiques) {
                Object.values(planta.caracteristiques).forEach(valor => {
                    if (Array.isArray(valor)) {
                        info.push(...valor);
                    } else if (valor) {
                        info.push(valor);
                    }
                });
            }
            
            if (planta.usos) {
                const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...usosNetejats);
            }
            
            if (planta.colors) {
                const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...colorsNetejats);
            }
            
            if (planta.habitat) {
                const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...habitatsNetejats);
            }
            
            return info.filter(i => i).join(' ');
        }
        
        // Carregar dades i inicialitzar DESPR√âS que tots els scripts estiguin carregats
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Mostrar loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // PRIMER: Verificar imatges dels marges
                verificarImatgesMarges();
                
                // Carregar dades de plantes
                const response = await fetch('dades/plantes.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Assignar imatges autom√†ticament
                const sistemaImatges = new SistemaImatges();
                const plantesAmbImatges = await sistemaImatges.processarTotesLesPlantes(data.plantes || data);
                
                // Assignar a variables globals
                gb_plantes_data = plantesAmbImatges;
                mb_vars.dades_plantes = processarDadesPerMapa(plantesAmbImatges);
                
                console.log('Dades carregades:', plantesAmbImatges.length, 'plantes amb imatges');
                
                // Esperar que les funcions estiguin disponibles
                let intents = 0;
                const esperarFuncions = () => {
                    if (typeof window.generarGaleriaHTML === 'function' && typeof window.generarMapaHTML === 'function') {
                        // Generar contingut de la galeria
                        window.generarGaleriaHTML(plantesAmbImatges).then(() => {
                            // Generar contingut del mapa
                            return window.generarMapaHTML();
                        }).then(() => {
                            // Amagar loading
                            document.getElementById('loading-overlay').classList.add('hidden');
                            console.log('Aplicaci√≥ inicialitzada correctament');
                        });
                    } else {
                        intents++;
                        if (intents < 50) { // M√†xim 5 segons d'espera
                            setTimeout(esperarFuncions, 100);
                        } else {
                            console.error('No s\'han pogut carregar les funcions necess√†ries');
                            document.getElementById('loading-overlay').innerHTML = 
                                '<div style="color: red; text-align: center;"><h3>Error carregant l\'aplicaci√≥</h3><p>Si us plau, recarrega la p√†gina.</p></div>';
                        }
                    }
                };
                
                esperarFuncions();
                
            } catch (error) {
                console.error('Error carregant dades:', error);
                document.getElementById('loading-overlay').innerHTML = 
                    `<div style="color: red; text-align: center;">
                        <h3>Error carregant les dades</h3>
                        <p>${error.message}</p>
                        <p>Si us plau, recarrega la p√†gina.</p>
                    </div>`;
            }
        });
    </script>
</body>
</html>
