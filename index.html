<!-- Script d'inicialització (DESPRÉS de carregar els altres scripts) -->
    <script>
        // Funcions de navegació
        function mostrarGaleria() {
            document.getElementById('galeria-section').style.display = 'block';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-galeria').classList.add('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarMapa() {
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'block';
            
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.add('active');
            
            // Redimensionar el mapa si ja existeix
            if (window.map) {
                setTimeout(() => window.map.invalidateSize(), 100);
            }
        }
        
        // Processar dades per al mapa (format compatible)
        function processarDadesPerMapa(plantes) {
            return plantes.map(planta => ({
                ...planta,
                imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
                habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio_norm: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? 
                        planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                        [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
                usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
                fullatge: planta.caracteristiques?.fullatge || '',
                info_completa: construirInfoCompleta(planta)
            }));
        }
        
        // Construir informació completa per la cerca
        function construirInfoCompleta(planta) {
            let info = [
                planta.nom_comu, 
                planta.nom_cientific, 
                planta.familia, 
                planta.descripcio, 
                planta.tipus
            ];
            
            if (planta.caracteristiques) {
                Object.values(planta.caracteristiques).forEach(valor => {
                    if (Array.isArray(valor)) {
                        info.push(...valor);
                    } else if (valor) {
                        info.push(valor);
                    }
                });
            }
            
            if (planta.usos) {
                const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...usosNetejats);
            }
            
            if (planta.colors) {
                const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...colorsNetejats);
            }
            
            if (planta.habitat) {
                const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...habitatsNetejats);
            }
            
            return info.filter(i => i).join(' ');
        }
        
        // Esperar a que tots els scripts estiguin carregats
        function inicialitzarApp() {
            // Verificar que les funcions necessàries existeixen
            if (typeof generarGaleriaHTML === 'undefined') {
                console.error('generarGaleriaHTML no està definida. Reintentant...');
                setTimeout(inicialitzarApp, 100);
                return;
            }
            
            if (typeof generarMapaHTML === 'undefined') {
                console.error('generarMapaHTML no està definida. Reintentant...');
                setTimeout(inicialitzarApp, 100);
                return;
            }
            
            // Ara podem inicialitzar l'aplicació
            carregarDadesIInicialitzar();
        }
        
        // Carregar dades i inicialitzar
        async function carregarDadesIInicialitzar() {
            try {
                // Mostrar loading
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                // Carregar dades de plantes
                const response = await fetch('dades/plantes.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Assignar a variables globals
                gb_plantes_data = data;
                mb_vars.dades_plantes = processarDadesPerMapa(data);
                
                console.log('Dades carregades:', data.length, 'plantes');
                
                // Generar contingut de la galeria
                await generarGaleriaHTML(data);
                
                // Generar contingut del mapa
                await generarMapaHTML();
                
                // Amagar loading
                document.getElementById('loading-overlay').classList.add('hidden');
                
                console.log('Aplicació inicialitzada correctament');
                
            } catch (error) {
                console.error('Error carregant dades:', error);
                document.getElementById('loading-overlay').innerHTML = 
                    `<div style="color: red; text-align: center;">
                        <h3>Error carregant les dades</h3>
                        <p>${error.message}</p>
                        <p>Si us plau, recarrega la pàgina.</p>
                    </div>`;
            }
        }
        
        // Inicialitzar quan el DOM estigui llest
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar un moment a que tots els scripts es carreguin
            setTimeout(inicialitzarApp, 500);
        });
    </script>
