<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria Botànica UAB</title>
    
    <!-- Leaflet CSS per al mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Estils propis -->
    <link rel="stylesheet" href="assets/css/galeria-botanica.css">
    <link rel="stylesheet" href="assets/css/mapa-botanica.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Galeria Botànica UAB</h1>
            <nav class="app-nav">
                <button onclick="mostrarInici()" class="nav-btn active" id="btn-inici">Inici</button>
                <button onclick="mostrarGaleria()" class="nav-btn" id="btn-galeria">Galeria</button>
                <button onclick="mostrarMapa()" class="nav-btn" id="btn-mapa">Mapa</button>
            </nav>
        </header>

        <main class="app-main">
            <!-- INICI -->
            <div id="inici-section">
                <div class="inici-hero">
                    <h1>🌿 Galeria i Mapa Botànica UAB</h1>
                    <div class="subtitol">Descobreix la biodiversitat del campus de la Universitat Autònoma de Barcelona</div>
                    <div class="descripcio">
                        Benvinguts i benvingudes al portal que converteix els <strong>260 ha</strong> de zones verdes de la UAB 
                        en un herbari digital interactiu.
                    </div>
                    
                    <div class="inici-stats">
                        <div class="stat-item">
                            <span class="stat-number">300+</span>
                            <span class="stat-label">Espècies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">1800+</span>
                            <span class="stat-label">Fotografies</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number">260</span>
                            <span class="stat-label">Hectàrees</span>
                        </div>
                    </div>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        🍃 Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        🗺️ Viatja pel Mapa
                    </a>
                </div>

                <div class="inici-grid">
                    <div class="inici-card">
                        <h3>🔍 Galeria Botànica</h3>
                        <p>Un catàleg visual filtrable amb fotos detallades (flor, fulla, fruit, hàbit) i fitxa completa.</p>
                        <p><strong>Com t'ajuda:</strong> Identifica espècies ràpidament amb filtres per color, hàbitat o època de floració.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>🗺️ Mapa Botànic</h3>
                        <p>Un mapa interactiu amb marcadors geolocalitzats i rutes temàtiques que situa cada planta <em>in situ</em>.</p>
                        <p><strong>Com t'ajuda:</strong> Organitza sortides, troba exemplars singulars i segueix itineraris auto-guiats.</p>
                    </div>
                    
                    <div class="inici-card">
                        <h3>⚡ Cercador Instantani</h3>
                        <p>Cerca per nom científic o vulgar en temps real.</p>
                        <p><strong>Com t'ajuda:</strong> Troba la planta que busques en segons.</p>
                    </div>
                </div>

                <div class="inici-card">
                    <h3>🎯 Per què un catàleg botànic del campus?</h3>
                    <p>El campus de Bellaterra és molt més que aules i laboratoris: és un mosaic de <strong>boscos mediterranis, torrents i camps</strong> que actua de corredor biològic entre el Massís de Sant Llorenç i Collserola. Documentar-ho té tres grans avantatges:</p>
                    
                    <table class="inici-table">
                        <thead>
                            <tr>
                                <th>Àmbit</th>
                                <th>Com t'ajuda</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>📚 Docència</strong></td>
                                <td>Facilita la identificació de plantes durant sortides de camp i pràctiques</td>
                            </tr>
                            <tr>
                                <td><strong>🔬 Ciència</strong></td>
                                <td>Genera dades fiables per a projectes de recerca i seguiment de biodiversitat</td>
                            </tr>
                            <tr>
                                <td><strong>🌱 Divulgació</strong></td>
                                <td>Apropa la botànica a qualsevol persona que passegi pel campus</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="zones-clau">
                    <h3>🗺️ Zones clau per començar a explorar</h3>
                    
                    <div class="zona-item">
                        <div class="zona-nom">🌳 Camí de Ho Chi Minh</div>
                        <div>Alzinar amb arbusts mediterranis i orquídies de primavera.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">🌊 Torrent de Can Domènech</div>
                        <div>Vegetació de ribera amb salzes, joncs i freixes.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">🌺 Eix Central</div>
                        <div>Arborets ornamentals que combinen espècies autòctones i exòtiques.</div>
                    </div>
                    
                    <div class="zona-item">
                        <div class="zona-nom">🌾 Rondes del campus</div>
                        <div>Prats oberts ideals per observar floració estacional d'herbàcies.</div>
                    </div>
                </div>

                <div class="caracteristiques-tecniques">
                    <h3>⚙️ Com s'ha construït la plataforma?</h3>
                    <ul>
                        <li><strong>Plugin de WordPress</strong> 100% codi obert – dos <em>shortcodes</em> carreguen la galeria i el mapa.</li>
                        <li><strong>Fitxer únic <code>plantes.json</code></strong> – la "font de la veritat" que evita dades duplicades.</li>
                        <li><strong>Leaflet + Tailwind</strong> – mapa lleuger i disseny adaptat a mòbil i escriptori.</li>
                        <li><strong>Editor offline integrat</strong> – afegeix o edita espècies sense tocar codi gràcies a la File System Access API (opcional).</li>
                        <li><strong>Llicència MIT</strong> – pots forquejar, millorar o portar el projecte al teu entorn.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>👥 A qui va dirigit?</h3>
                    <ul>
                        <li><strong>Estudiantat de Biologia, Ciències Ambientals i Educació</strong> – recurs per a pràctiques i TFG/TFM.</li>
                        <li><strong>Professorat</strong> – material didàctic per a classes i sortides.</li>
                        <li><strong>Investigadors/es</strong> – punt de partida per a estudis de biodiversitat local.</li>
                        <li><strong>Públic general</strong> – eina per gaudir i entendre la natura del campus.</li>
                    </ul>
                </div>

                <div class="inici-card">
                    <h3>🚀 Plans de futur</h3>
                    <ol>
                        <li><strong>Miniatures WebP</strong> per accelerar encara més la galeria.</li>
                        <li><strong>API REST</strong> perquè aplicacions mòbils (p. ex. Planttes) consumeixin dades en temps real.</li>
                        <li><strong>Versió PWA</strong> amb funcionalitat offline completa.</li>
                        <li><strong>Traducció multilingüe</strong> per compartir el recurs amb estudiants internacionals.</li>
                        <li><strong>Nous camps</strong>: pol·linitzadors, estatus de protecció i fenologia mensual.</li>
                    </ol>
                </div>

                <div class="col-laboracio">
                    <h3>🤝 Com pots col·laborar?</h3>
                    
                    <div class="col-laboracio-grid">
                        <div class="col-laboracio-item">
                            <strong>📸 Afegir dades o fotos</strong><br>
                            Obre un <em>Pull Request</em> o puja una <em>Issue</em> amb la teva proposta.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>🐛 Reportar un error</strong><br>
                            Indica la planta, captura de pantalla i pas a pas per reproduir-lo.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>🌍 Traduir la interfície</strong><br>
                            Crea un fitxer a <code>/lang</code> seguint l'estructura JSON existent.
                        </div>
                        
                        <div class="col-laboracio-item">
                            <strong>🚶 Organitzar una sortida guiada</strong><br>
                            Escriu a <a href="mailto:botanica@uab.cat" style="color: #E8F5E8;">botanica@uab.cat</a>
                        </div>
                    </div>
                </div>

                <div class="credits">
                    <h3>👨‍🎓 Crèdits</h3>
                    <p>Projecte desenvolupat com a <strong>Treball de Fi de Grau</strong> a la Facultat de Biociències de la UAB.</p>
                    <p><strong>Autor:</strong> <em>Tomás González Bartomeu</em></p>
                    <p><strong>Tutor acadèmic:</strong> <em>Ramon Pérez Obiol</em></p>
                </div>

                <div class="cta-buttons">
                    <a href="#" onclick="mostrarGaleria()" class="cta-btn">
                        🍃 Explora la Galeria
                    </a>
                    <a href="#" onclick="mostrarMapa()" class="cta-btn secondary">
                        🗺️ Viatja pel Mapa
                    </a>
                </div>

                <div style="text-align: center; margin: 2rem 0; color: #4CAF50; font-size: 1.2rem; font-weight: 600;">
                    🌱 Ajuda'ns a fer créixer el coneixement de la flora local!
                </div>
            </div>

            <!-- GALERIA -->
            <div id="galeria-section" class="galeria-botanica" style="display: none;">
                <!-- Els filtres i la graella es generaran dinàmicament amb JS -->
            </div>

            <!-- MAPA -->
            <div id="mapa-section" class="mapa-botanica-contenidor" style="display: none;">
                <!-- Els filtres del mapa es generaran dinàmicament -->
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    
    <!-- Variables globals per compatibilitat amb WordPress -->
    <script>
        // Variables globals necessàries per als scripts originals
        var gb_vars = {
            ajaxurl: 'api/ajax.php' // Simulem l'AJAX de WordPress
        };
        
        var mb_vars = {
            ajaxurl: 'api/ajax.php',
            plugin_url: '.',
            dades_plantes: [] // Es carregarà dinàmicament
        };
        
        // Variable global per a les dades de plantes (per la galeria)
        var gb_plantes_data = [];

        // Funció per verificar si les imatges dels marges existeixen
        async function verificarImatgesMarges() {
            const imatgeEsquerra = 'assets/imatges/marge-esquerra.png';
            const imatgeDreta = 'assets/imatges/marge-dreta.png';
            
            try {
                // Test imatge esquerra
                const imgEsq = new Image();
                const promiseEsq = new Promise((resolve) => {
                    imgEsq.onload = () => resolve(true);
                    imgEsq.onerror = () => resolve(false);
                    imgEsq.src = imatgeEsquerra;
                });
                
                // Test imatge dreta
                const imgDreta = new Image();
                const promiseDreta = new Promise((resolve) => {
                    imgDreta.onload = () => resolve(true);
                    imgDreta.onerror = () => resolve(false);
                    imgDreta.src = imatgeDreta;
                });
                
                // Esperar ambdues imatges
                const [esquerraExisteix, dretaExisteix] = await Promise.all([promiseEsq, promiseDreta]);
                
                // Si ambdues imatges existeixen, activar els marges
                if (esquerraExisteix && dretaExisteix) {
                    document.body.classList.add('marges-actius');
                    console.log('✅ Marges decoratius activats - imatges carregades correctament');
                } else {
                    console.warn('⚠️ Marges decoratius desactivats - imatges no trobades');
                    console.log(`Imatge esquerra: ${esquerraExisteix ? '✅' : '❌'}`);
                    console.log(`Imatge dreta: ${dretaExisteix ? '✅' : '❌'}`);
                }
            } catch (error) {
                console.error('Error verificant imatges dels marges:', error);
            }
        }

        // Sistema d'assignació automàtica d'imatges des de GitHub
        class SistemaImatgesGitHub {
            constructor() {
                this.cache = new Map();
                this.llistaImatges = null;
                this.githubAPI = 'https://api.github.com/repos/PoltorProgrammer/TFG_Galeria_Botanica_Maig_2025/contents/assets/imatges';
            }

            nomCientificAFitxer(nomCientific) {
                return nomCientific.toLowerCase()
                                  .replace(/\s+/g, '_')
                                  .replace(/[^a-z0-9_]/g, '');
            }

            async carregarImatgesDeGitHub() {
                if (this.llistaImatges) {
                    return this.llistaImatges;
                }

                try {
                    console.log('🔍 Carregant llista d\'imatges des de GitHub...');
                    
                    const response = await fetch(this.githubAPI);
                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status}`);
                    }
                    
                    const fitxers = await response.json();
                    
                    this.llistaImatges = fitxers
                        .filter(fitxer => {
                            if (fitxer.type !== 'file') return false;
                            if (!fitxer.name.endsWith('.jpg')) return false;
                            const patro = /^[a-z_]+_\d{2}_[a-z]+\.jpg$/i;
                            return patro.test(fitxer.name);
                        })
                        .map(fitxer => fitxer.name)
                        .sort();
                    
                    console.log(`✅ Carregades ${this.llistaImatges.length} imatges des de GitHub`);
                    return this.llistaImatges;
                    
                } catch (error) {
                    console.error('❌ Error carregant imatges de GitHub:', error);
                    this.llistaImatges = [];
                    return this.llistaImatges;
                }
            }

            async trobarImatgesPlanta(nomCientific) {
                if (this.cache.has(nomCientific)) {
                    return this.cache.get(nomCientific);
                }
                
                const nomFitxer = this.nomCientificAFitxer(nomCientific);
                const llistaCompleta = await this.carregarImatgesDeGitHub();
                
                const imatgesPlanta = llistaCompleta.filter(imatge => 
                    imatge.startsWith(nomFitxer + '_')
                );
                
                const imatgesProcessades = imatgesPlanta.map(nomImatge => {
                    const parts = nomImatge.replace('.jpg', '').split('_');
                    const numero = parseInt(parts[parts.length - 2]);
                    const tipus = parts[parts.length - 1];
                    
                    return {
                        nom: nomImatge,
                        ruta: `assets/imatges/${nomImatge}`,
                        numero: numero,
                        tipus: tipus
                    };
                }).sort((a, b) => {
                    if (a.numero !== b.numero) {
                        return a.numero - b.numero;
                    }
                    
                    const prioritat = {
                        'habit': 1, 'flor': 2, 'fulla': 3,
                        'fruit': 4, 'tija': 5, 'altre': 6
                    };
                    
                    return (prioritat[a.tipus] || 10) - (prioritat[b.tipus] || 10);
                });
                
                this.cache.set(nomCientific, imatgesProcessades);
                return imatgesProcessades;
            }

            async assignarImatgesPlanta(planta) {
                const imatgesTrobades = await this.trobarImatgesPlanta(planta.nom_cientific);
                
                if (imatgesTrobades.length === 0) {
                    return {
                        principal: null,
                        principal_tipus: 'general',
                        detalls: [],
                        detalls_tipus: []
                    };
                }
                
                const principal = imatgesTrobades[0];
                const detalls = imatgesTrobades.slice(1);
                
                return {
                    principal: principal.nom,
                    principal_tipus: principal.tipus,
                    detalls: detalls.map(img => img.nom),
                    detalls_tipus: detalls.map(img => img.tipus)
                };
            }

            async processarTotesLesPlantes(plantes) {
                console.log('🚀 Iniciant assignació automàtica d\'imatges des de GitHub...');
                
                await this.carregarImatgesDeGitHub();
                const plantesAmbImatges = [];
                
                for (let i = 0; i < plantes.length; i++) {
                    const planta = plantes[i];
                    
                    if (i % 5 === 0 || i === plantes.length - 1) {
                        console.log(`📊 Progrés: ${i + 1}/${plantes.length} plantes processades`);
                    }
                    
                    const imatges = await this.assignarImatgesPlanta(planta);
                    plantesAmbImatges.push({
                        ...planta,
                        imatges: imatges
                    });
                }
                
                console.log('🎉 Assignació GitHub completada!');
                return plantesAmbImatges;
            }
        }

        // Funcions de navegació
        function mostrarInici() {
            document.getElementById('inici-section').style.display = 'block';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.add('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarGaleria() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'block';
            document.getElementById('mapa-section').style.display = 'none';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.add('active');
            document.getElementById('btn-mapa').classList.remove('active');
        }

        function mostrarMapa() {
            document.getElementById('inici-section').style.display = 'none';
            document.getElementById('galeria-section').style.display = 'none';
            document.getElementById('mapa-section').style.display = 'block';
            
            document.getElementById('btn-inici').classList.remove('active');
            document.getElementById('btn-galeria').classList.remove('active');
            document.getElementById('btn-mapa').classList.add('active');
            
            if (window.map) {
                setTimeout(() => window.map.invalidateSize(), 100);
            }
        }
        
        // Processar dades per al mapa
        function processarDadesPerMapa(plantes) {
            return plantes.map(planta => ({
                ...planta,
                imatge: planta.imatges?.principal ? `assets/imatges/${planta.imatges.principal}` : '',
                habitat_norm: planta.habitat ? planta.habitat.map(h => h.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio_norm: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? 
                        planta.caracteristiques.floracio.map(f => f.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')) : 
                        [planta.caracteristiques.floracio.toLowerCase().replace(/\s*\(.*?\)\s*/g, '')]) : [],
                usos_norm: planta.usos ? planta.usos.map(u => u.toLowerCase().replace(/\s+/g, '_').replace(/\s*\(.*?\)\s*/g, '')) : [],
                floracio: planta.caracteristiques?.floracio ? 
                    (Array.isArray(planta.caracteristiques.floracio) ? planta.caracteristiques.floracio : [planta.caracteristiques.floracio]) : [],
                fullatge: planta.caracteristiques?.fullatge || '',
                info_completa: construirInfoCompleta(planta)
            }));
        }
        
        // Construir informació completa per la cerca
        function construirInfoCompleta(planta) {
            let info = [
                planta.nom_comu, 
                planta.nom_cientific, 
                planta.familia, 
                planta.descripcio, 
                planta.tipus
            ];
            
            if (planta.caracteristiques) {
                Object.values(planta.caracteristiques).forEach(valor => {
                    if (Array.isArray(valor)) {
                        info.push(...valor);
                    } else if (valor) {
                        info.push(valor);
                    }
                });
            }
            
            if (planta.usos) {
                const usosNetejats = planta.usos.map(us => us.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...usosNetejats);
            }
            
            if (planta.colors) {
                const colorsNetejats = planta.colors.map(c => c.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...colorsNetejats);
            }
            
            if (planta.habitat) {
                const habitatsNetejats = planta.habitat.map(h => h.replace(/\s*\(.*?\)\s*/g, '').trim());
                info.push(...habitatsNetejats);
            }
            
            return info.filter(i => i).join(' ');
        }
        
        // Inicialització principal
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Iniciant aplicació...');
                
                // Verificar imatges dels marges
                verificarImatgesMarges();
                
                // Carregar dades de plantes
                const response = await fetch('dades/plantes.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                const data = await response.json();
                
                // Assignar imatges automàticament des de GitHub
                const sistemaImatges = new SistemaImatgesGitHub();
                const plantesAmbImatges = await sistemaImatges.processarTotesLesPlantes(data.plantes || data);
                
                // Assignar a variables globals
                gb_plantes_data = plantesAmbImatges;
                mb_vars.dades_plantes = processarDadesPerMapa(plantesAmbImatges);
                
                console.log('Dades carregades:', plantesAmbImatges.length, 'plantes');
                
                // Esperar que les funcions estiguin disponibles
                let intents = 0;
                const esperarFuncions = () => {
                    if (typeof window.generarGaleriaHTML === 'function' && typeof window.generarMapaHTML === 'function') {
                        // Generar contingut
                        window.generarGaleriaHTML(plantesAmbImatges).then(() => {
                            return window.generarMapaHTML();
                        }).then(() => {
                            console.log('✅ Aplicació inicialitzada correctament');
                        }).catch(error => {
                            console.error('Error inicialitzant:', error);
                        });
                    } else {
                        intents++;
                        if (intents < 50) {
                            setTimeout(esperarFuncions, 100);
                        } else {
                            console.error('❌ No s\'han pogut carregar les funcions necessàries');
                        }
                    }
                };
                
                esperarFuncions();
                
            } catch (error) {
                console.error('❌ Error carregant aplicació:', error);
            }
        });
    </script>
    
    <!-- Scripts originals -->
    <script src="assets/js/galeria-botanica-original.js"></script>
    <script src="assets/js/mapa-botanica-original.js"></script>
</body>
</html>
